<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éì„É≥„Ç¥„É°„Éº„Ç´„Éº | Bingo Maker | Ë≥ìÊûúÁî¢ÁîüÂô®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }

        /* Ë™ûË®ÄÂàáÊèõ */
        .lang-switcher {
            position: fixed;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 5px;
            z-index: 100;
            background: rgba(0,0,0,0.3);
            padding: 5px;
            border-radius: 8px;
        }

        .lang-btn {
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .lang-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .lang-btn.active {
            background: linear-gradient(135deg, #00c853 0%, #69f0ae 100%);
        }

        /* Ëµ∑ÂßãÁï´Èù¢ */
        .start-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            gap: 30px;
        }

        .start-screen h1 {
            font-size: 2.5rem;
            text-shadow: 0 0 20px rgba(105, 240, 174, 0.5);
        }

        .start-screen .subtitle {
            color: #aaa;
            text-align: center;
        }

        .size-selection {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .size-btn {
            padding: 30px 50px;
            font-size: 1.5rem;
            background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
            border: 3px solid transparent;
            border-radius: 16px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .size-btn:hover {
            transform: scale(1.05);
            border-color: #69f0ae;
            box-shadow: 0 10px 30px rgba(105, 240, 174, 0.3);
        }

        .load-section {
            margin-top: 30px;
            text-align: center;
        }

        .load-section h3 {
            margin-bottom: 15px;
            color: #aaa;
        }

        .code-input-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .code-input {
            padding: 12px 20px;
            font-size: 1.2rem;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            text-align: center;
            letter-spacing: 3px;
            width: 150px;
        }

        .code-input::placeholder {
            color: rgba(255,255,255,0.4);
            letter-spacing: 1px;
        }

        .load-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #00c853 0%, #69f0ae 100%);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .load-btn:hover {
            transform: scale(1.05);
        }

        /* Ë®™ÂÆ¢Ë®àÊï∏ */
        .visitor-counter {
            margin-top: 40px;
            text-align: center;
            color: #666;
            font-size: 0.85rem;
        }

        .visitor-counter span {
            color: #69f0ae;
            font-weight: bold;
        }

        /* ‰∏ªË¶ÅÁâàÈù¢ */
        .main-layout {
            display: none;
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .main-layout.active {
            display: flex;
        }

        .bingo-section {
            flex: 1;
            max-width: 800px;
        }

        .log-section {
            width: 350px;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 1.8rem;
            text-shadow: 0 0 20px rgba(105, 240, 174, 0.5);
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bingo-code {
            background: rgba(105, 240, 174, 0.2);
            padding: 8px 16px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 1.1rem;
            letter-spacing: 2px;
        }

        .back-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Áµ±Ë®à */
        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stats {
            display: flex;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #aaa;
        }

        .stat-item.completed .stat-number { color: #69f0ae; }
        .stat-item.almost .stat-number { color: #ffff00; }
        .stat-item.pending .stat-number { color: #636e72; }
        .stat-item.lines .stat-number {
            color: #ff6b6b;
            font-size: 2rem;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.6);
        }
        .stat-item.lines {
            background: rgba(255, 107, 107, 0.15);
            padding: 10px 20px;
            border-radius: 12px;
            border: 2px solid rgba(255, 107, 107, 0.3);
        }

        /* Âúñ‰æã */
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .legend-color.completed { background: linear-gradient(135deg, #00c853 0%, #69f0ae 100%); }
        .legend-color.almost { background: linear-gradient(135deg, #ffd600 0%, #ffff00 100%); }
        .legend-color.pending { background: linear-gradient(135deg, #2d3436 0%, #636e72 100%); }

        /* Ë≥ìÊûúÊ†º */
        .bingo-container {
            position: relative;
            margin-bottom: 25px;
        }

        .bingo-grid {
            display: grid;
            gap: 10px;
            position: relative;
        }

        /* ÈÄ£Á∑öÊïàÊûú */
        .bingo-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .bingo-line {
            position: absolute;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #ff6b6b);
            background-size: 200% 100%;
            animation: lineGlow 2s ease-in-out infinite;
            border-radius: 4px;
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.8), 0 0 30px rgba(255, 107, 107, 0.4);
        }

        @keyframes lineGlow {
            0%, 100% { background-position: 0% 50%; opacity: 0.9; }
            50% { background-position: 100% 50%; opacity: 1; }
        }

        .bingo-line.horizontal {
            height: 6px;
            left: 5%;
            width: 90%;
        }

        .bingo-line.vertical {
            width: 6px;
            top: 5%;
            height: 90%;
        }

        .bingo-line.diagonal {
            height: 6px;
            transform-origin: left center;
        }

        .bingo-grid.size-3 { grid-template-columns: repeat(3, 1fr); }
        .bingo-grid.size-4 { grid-template-columns: repeat(4, 1fr); }
        .bingo-grid.size-5 { grid-template-columns: repeat(5, 1fr); }

        .bingo-cell {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            text-align: center;
            user-select: none;
            position: relative;
            overflow: hidden;
        }

        .bingo-cell::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at center, rgba(255,255,255,0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .bingo-cell:hover::before { opacity: 1; }
        .bingo-cell:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .bingo-cell.completed {
            background: linear-gradient(135deg, #00c853 0%, #69f0ae 100%);
            border-color: #00e676;
            box-shadow: 0 0 20px rgba(0, 200, 83, 0.4);
        }

        .bingo-cell.almost {
            background: linear-gradient(135deg, #ffd600 0%, #ffff00 100%);
            border-color: #ffea00;
            box-shadow: 0 0 20px rgba(255, 214, 0, 0.4);
            color: #333;
        }

        .bingo-cell.empty {
            border: 2px dashed rgba(255,255,255,0.3);
            background: transparent;
        }

        .bingo-cell.empty:hover {
            border-color: #69f0ae;
        }

        .cell-title {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 4px;
            line-height: 1.2;
            word-break: break-word;
        }

        .cell-target {
            font-size: 0.85rem;
            opacity: 0.9;
            word-break: break-word;
        }

        .cell-status {
            position: absolute;
            top: 6px;
            right: 6px;
            font-size: 1.1rem;
        }

        .cell-difficulty {
            position: absolute;
            bottom: 6px;
            left: 0;
            right: 0;
            font-size: 0.85rem;
            color: #ffd700;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }

        .bingo-cell.almost .cell-difficulty {
            color: #b8860b;
            text-shadow: none;
        }

        .empty-hint {
            font-size: 1.5rem;
            color: rgba(255,255,255,0.3);
        }

        /* ÊåâÈàïÂàó */
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: scale(1.05);
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #00c853 0%, #69f0ae 100%);
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .action-btn.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .action-btn.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        /* Log Section */
        .log-section h2 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            text-align: center;
            color: #69f0ae;
        }

        .log-input-area {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .log-input-area input {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 0.9rem;
        }

        .log-input-area input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .log-input-area button {
            padding: 10px 15px;
            background: linear-gradient(135deg, #00c853 0%, #69f0ae 100%);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .log-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .log-item {
            background: rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            position: relative;
            border-left: 4px solid #69f0ae;
        }

        .log-item .log-date {
            font-size: 0.7rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .log-item .log-content {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .log-item .delete-log {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 1rem;
            opacity: 0.6;
        }

        .log-item .delete-log:hover { opacity: 1; }

        .log-empty {
            text-align: center;
            color: #666;
            padding: 30px;
            font-size: 0.9rem;
        }

        /* Á∑®ËºØÂΩàÁ™ó */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            border: 2px solid rgba(105, 240, 174, 0.3);
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #69f0ae;
            text-align: center;
        }

        .modal-field {
            margin-bottom: 15px;
        }

        .modal-field label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #aaa;
        }

        .modal-field input,
        .modal-field select {
            width: 100%;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 0.95rem;
        }

        .modal-field select option {
            background: #1a1a2e;
        }

        .difficulty-stars {
            display: flex;
            gap: 8px;
            margin-top: 5px;
        }

        .difficulty-stars span {
            font-size: 1.5rem;
            cursor: pointer;
            color: #636e72;
            transition: color 0.2s;
        }

        .difficulty-stars span.active {
            color: #ffd700;
        }

        .difficulty-stars span:hover {
            color: #ffea00;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-buttons .save-btn {
            background: linear-gradient(135deg, #00c853 0%, #69f0ae 100%);
            color: #fff;
        }

        .modal-buttons .cancel-btn {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .modal-buttons .delete-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: #fff;
            flex: 0.5;
        }

        /* Toast ÈÄöÁü• */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0,0,0,0.9);
            color: #fff;
            padding: 15px 30px;
            border-radius: 8px;
            z-index: 2000;
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* RWD */
        @media (max-width: 1000px) {
            .main-layout {
                flex-direction: column;
            }
            .bingo-section { max-width: 100%; }
            .log-section {
                width: 100%;
                position: static;
            }
        }

        @media (max-width: 600px) {
            .header { flex-direction: column; text-align: center; }
            .stats-bar { flex-direction: column; align-items: center; }
            .cell-title { font-size: 0.8rem; }
            .cell-target { font-size: 0.7rem; }
            .cell-difficulty { font-size: 0.7rem; }
            .action-btn { padding: 8px 12px; font-size: 0.75rem; }
            .lang-switcher { top: 10px; right: 10px; }
            .lang-btn { padding: 4px 8px; font-size: 0.7rem; }
            .stat-item.lines { padding: 8px 15px; }
            .stat-item.lines .stat-number { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <!-- Ë™ûË®ÄÂàáÊèõ -->
    <div class="lang-switcher">
        <button class="lang-btn active" onclick="setLanguage('ja')">Êó•Êú¨Ë™û</button>
        <button class="lang-btn" onclick="setLanguage('zh')">‰∏≠Êñá</button>
        <button class="lang-btn" onclick="setLanguage('en')">EN</button>
    </div>

    <!-- Ëµ∑ÂßãÁï´Èù¢ -->
    <div class="start-screen" id="startScreen">
        <h1 data-i18n="title">üéØ „Éì„É≥„Ç¥„É°„Éº„Ç´„Éº</h1>
        <p class="subtitle" data-i18n="subtitle">„Çµ„Ç§„Ç∫„ÇíÈÅ∏„Çì„ÅßÊñ∞„Åó„ÅÑ„Éì„É≥„Ç¥„Çí‰ΩúÊàê„ÄÅ„Åæ„Åü„ÅØ„Ç≥„Éº„Éâ„ÅßÊó¢Â≠ò„ÅÆ„Éì„É≥„Ç¥„ÇíË™≠„ÅøËæº„Åø</p>

        <div class="size-selection">
            <button class="size-btn" onclick="createNewBingo(3)">3 √ó 3</button>
            <button class="size-btn" onclick="createNewBingo(4)">4 √ó 4</button>
            <button class="size-btn" onclick="createNewBingo(5)">5 √ó 5</button>
        </div>

        <div class="load-section">
            <h3 data-i18n="loadExisting">„Åæ„Åü„ÅØÊó¢Â≠ò„ÅÆ„Éì„É≥„Ç¥„ÇíË™≠„ÅøËæº„ÇÄ</h3>
            <div class="code-input-group">
                <input type="text" class="code-input" id="loadCodeInput" data-i18n-placeholder="codeInputPlaceholder" placeholder="6Ê°ÅÂÖ•Âäõ" maxlength="6" oninput="this.value = this.value.toUpperCase()">
                <button class="load-btn" onclick="loadBingoByCode()" data-i18n="loadBtn">Ë™≠Ëæº</button>
            </div>
        </div>

        <div class="visitor-counter">
            üåê ÂÖ®Ë®™ÂÆ¢Á¥ØË®àÔºö
            <span id="visitorCount">-</span> ÂºµË°®„Éª
            <span id="globalCellCount">-</span> ÂÄãÊ†ºÂ≠êÈÅîÊàê
        </div>
    </div>

    <!-- ‰∏ªË¶ÅÁâàÈù¢ -->
    <div class="main-layout" id="mainLayout">
        <div class="bingo-section">
            <div class="header">
                <h1 id="bingoTitle" data-i18n="myBingo">„Éû„Ç§„Éì„É≥„Ç¥</h1>
                <div class="header-info">
                    <span class="bingo-code" id="bingoCode">ABC123</span>
                    <button class="back-btn" onclick="backToStart()" data-i18n="backBtn">‚Üê Êàª„Çã</button>
                </div>
            </div>

            <div class="stats-bar">
                <div class="stats">
                    <div class="stat-item completed">
                        <div class="stat-number" id="completedCount">0</div>
                        <div class="stat-label" data-i18n="statCompleted">ÈÅîÊàê</div>
                    </div>
                    <div class="stat-item almost">
                        <div class="stat-number" id="almostCount">0</div>
                        <div class="stat-label" data-i18n="statAlmost">ÈÄ≤Ë°å‰∏≠</div>
                    </div>
                    <div class="stat-item pending">
                        <div class="stat-number" id="pendingCount">0</div>
                        <div class="stat-label" data-i18n="statPending">Êú™ÁùÄÊâã</div>
                    </div>
                    <div class="stat-item lines">
                        <div class="stat-number" id="linesCount">0</div>
                        <div class="stat-label" data-i18n="statLines">„É©„Ç§„É≥</div>
                    </div>
                </div>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color completed"></div>
                    <span data-i18n="legendCompleted">ÈÅîÊàê ‚úì</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color almost"></div>
                    <span data-i18n="legendAlmost">ÈÄ≤Ë°å‰∏≠ ‚ö°</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color pending"></div>
                    <span data-i18n="legendPending">Êú™ÁùÄÊâã</span>
                </div>
            </div>

            <div class="bingo-container">
                <div class="bingo-lines" id="bingoLines"></div>
                <div class="bingo-grid" id="bingoGrid"></div>
            </div>

            <div class="action-buttons">
                <button class="action-btn primary" onclick="shareBingo()" data-i18n="btnShare">üì§ ÂÖ±Êúâ</button>
                <button class="action-btn secondary" onclick="saveAsImage()" data-i18n="btnSaveImage">üì∑ ÁîªÂÉè‰øùÂ≠ò</button>
                <button class="action-btn warning" onclick="shuffleBingo()" data-i18n="btnShuffle">üîÄ „Ç∑„É£„ÉÉ„Éï„É´</button>
                <button class="action-btn secondary" onclick="restoreOrder()" data-i18n="btnRestore">‚Ü©Ô∏è ÂÖÉ„Å´Êàª„Åô</button>
                <button class="action-btn danger" onclick="resetAllCells()" data-i18n="btnReset">üóëÔ∏è ÂÖ®„É™„Çª„ÉÉ„Éà</button>
            </div>
        </div>

        <div class="log-section">
            <h2 data-i18n="logTitle">üìù ÈÅîÊàêË®òÈå≤</h2>
            <div class="log-input-area">
                <input type="text" id="logInput" data-i18n-placeholder="logInputPlaceholder" placeholder="Ë®òÈå≤„ÇíÂÖ•Âäõ..." onkeypress="handleLogKeypress(event)">
                <button onclick="addLog()">+</button>
            </div>
            <div class="log-list" id="logList">
                <div class="log-empty" data-i18n="logEmpty">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜÔºÅ</div>
            </div>
        </div>
    </div>

    <!-- Á∑®ËºØÂΩàÁ™ó -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <h3 data-i18n="editModalTitle">„Éû„ÇπÁ∑®ÈõÜ</h3>
            <div class="modal-field">
                <label data-i18n="editLabelTitle">„Çø„Ç§„Éà„É´ÔºàÊõ≤ÂêçÔºâ</label>
                <input type="text" id="editTitle" data-i18n-placeholder="editTitlePlaceholder" placeholder="‰æãÔºöEGOISM 440">
            </div>
            <div class="modal-field">
                <label data-i18n="editLabelTarget">ÁõÆÊ®ô</label>
                <input type="text" id="editTarget" data-i18n-placeholder="editTargetPlaceholder" placeholder="‰æãÔºö95‰ª•‰∏ä„ÄÅ„Éï„É´„Ç≥„É≥„ÄÅ„ÇØ„É™„Ç¢">
            </div>
            <div class="modal-field">
                <label data-i18n="editLabelDifficulty">Èõ£ÊòìÂ∫¶</label>
                <div class="difficulty-stars" id="difficultyStars">
                    <span onclick="setDifficulty(1)">‚òÖ</span>
                    <span onclick="setDifficulty(2)">‚òÖ</span>
                    <span onclick="setDifficulty(3)">‚òÖ</span>
                    <span onclick="setDifficulty(4)">‚òÖ</span>
                    <span onclick="setDifficulty(5)">‚òÖ</span>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="delete-btn" onclick="deleteCell()" data-i18n="btnDelete">ÂâäÈô§</button>
                <button class="cancel-btn" onclick="closeModal()" data-i18n="btnCancel">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="save-btn" onclick="saveCell()" data-i18n="btnSave">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <!-- Ê®°ÊùøÈÅ∏ÊìáÂΩàÁ™ó -->
    <div class="modal-overlay" id="templateModal">
        <div class="modal">
            <h3 data-i18n="templateQuestion">DDR„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÅãÔºü</h3>
            <p style="text-align: center; margin-bottom: 20px; color: #aaa; font-size: 0.9rem;">
                24ÂÄã„ÅÆDDRÁõÆÊ®ô„Åã„Çâ„É©„É≥„ÉÄ„É†„ÅßÈÅ∏„Å≥„Åæ„Åô
            </p>
            <div class="modal-buttons" style="flex-direction: column; gap: 12px;">
                <button class="save-btn" onclick="createBingoWithTemplate(true)" data-i18n="templateYes" style="padding: 15px;">
                    „ÅØ„ÅÑ„ÄÅ„É©„É≥„ÉÄ„É†„ÅßÈÅ∏„Å∂
                </button>
                <button class="cancel-btn" onclick="createBingoWithTemplate(false)" data-i18n="templateNo" style="padding: 15px;">
                    „ÅÑ„ÅÑ„Åà„ÄÅÁ©∫ÁôΩ„ÅßÂßã„ÇÅ„Çã
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- html2canvas Áî®ÊñºÊà™Âúñ -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        // ===== Â§öË™ûË®ÄÁøªË≠Ø =====
        const translations = {
            ja: {
                title: 'üéØ „Éì„É≥„Ç¥„É°„Éº„Ç´„Éº',
                subtitle: '„Çµ„Ç§„Ç∫„ÇíÈÅ∏„Çì„ÅßÊñ∞„Åó„ÅÑ„Éì„É≥„Ç¥„Çí‰ΩúÊàê„ÄÅ„Åæ„Åü„ÅØ„Ç≥„Éº„Éâ„ÅßÊó¢Â≠ò„ÅÆ„Éì„É≥„Ç¥„ÇíË™≠„ÅøËæº„Åø',
                loadExisting: '„Åæ„Åü„ÅØÊó¢Â≠ò„ÅÆ„Éì„É≥„Ç¥„ÇíË™≠„ÅøËæº„ÇÄ',
                codeInputPlaceholder: '6Ê°ÅÂÖ•Âäõ',
                loadBtn: 'Ë™≠Ëæº',
                myBingo: '„Éû„Ç§„Éì„É≥„Ç¥',
                backBtn: '‚Üê Êàª„Çã',
                statCompleted: 'ÈÅîÊàê',
                statAlmost: 'ÈÄ≤Ë°å‰∏≠',
                statPending: 'Êú™ÁùÄÊâã',
                statLines: '„É©„Ç§„É≥',
                legendCompleted: 'ÈÅîÊàê ‚úì',
                legendAlmost: 'ÈÄ≤Ë°å‰∏≠ ‚ö°',
                legendPending: 'Êú™ÁùÄÊâã',
                btnShare: 'üì§ ÂÖ±Êúâ',
                btnSaveImage: 'üì∑ ÁîªÂÉè‰øùÂ≠ò',
                btnShuffle: 'üîÄ „Ç∑„É£„ÉÉ„Éï„É´',
                btnRestore: '‚Ü©Ô∏è ÂÖÉ„Å´Êàª„Åô',
                btnReset: 'üóëÔ∏è ÂÖ®„É™„Çª„ÉÉ„Éà',
                logTitle: 'üìù ÈÅîÊàêË®òÈå≤',
                logInputPlaceholder: 'Ë®òÈå≤„ÇíÂÖ•Âäõ...',
                logEmpty: '„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜÔºÅ',
                editModalTitle: '„Éû„ÇπÁ∑®ÈõÜ',
                editLabelTitle: '„Çø„Ç§„Éà„É´ÔºàÊõ≤ÂêçÔºâ',
                editTitlePlaceholder: '‰æãÔºöEGOISM 440',
                editLabelTarget: 'ÁõÆÊ®ô',
                editTargetPlaceholder: '‰æãÔºö95‰ª•‰∏ä„ÄÅ„Éï„É´„Ç≥„É≥„ÄÅ„ÇØ„É™„Ç¢',
                editLabelDifficulty: 'Èõ£ÊòìÂ∫¶',
                btnDelete: 'ÂâäÈô§',
                btnCancel: '„Ç≠„É£„É≥„Çª„É´',
                btnSave: '‰øùÂ≠ò',
                // Toast messages
                toastCreated: (size, code) => `${size}√ó${size} „Éì„É≥„Ç¥„Çí‰ΩúÊàê„Åó„Åæ„Åó„ÅüÔºÅ„Ç≥„Éº„ÉâÔºö${code}`,
                toastLoaded: 'Ë™≠„ÅøËæº„ÅøÊàêÂäüÔºÅ',
                toastSharedLoaded: 'ÂÖ±Êúâ„Åï„Çå„Åü„Éì„É≥„Ç¥„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºÅ',
                toastCodeRequired: '6Ê°Å„ÅÆ„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
                toastNotFound: '„Åì„ÅÆ„Ç≥„Éº„Éâ„ÅÆ„Éì„É≥„Ç¥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì',
                toastSaved: '‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ',
                toastDeleted: '„Éû„Çπ„ÅÆÂÜÖÂÆπ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü',
                toastShareCopied: 'ÂÖ±Êúâ„É™„É≥„ÇØ„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ',
                toastImageSaved: 'ÁîªÂÉè„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„ÅüÔºÅ',
                toastShuffled: '„Éì„É≥„Ç¥„Çí„Ç∑„É£„ÉÉ„Éï„É´„Åó„Åæ„Åó„ÅüÔºÅ',
                toastRestored: 'ÂÖÉ„ÅÆÈ†ÜÂ∫è„Å´Êàª„Åó„Åæ„Åó„ÅüÔºÅ',
                toastNoRestore: 'ÂÖÉ„Å´Êàª„Åõ„ÇãÈ†ÜÂ∫è„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',
                toastReset: 'ÂÖ®„Å¶„ÅÆÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü',
                confirmReset: 'ÂÖ®„Å¶„ÅÆ„Éû„Çπ„ÅÆÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü',
                logAchieved: (title, target) => `‚úì ÈÅîÊàêÔºö${title} - ${target}`,
                // Template
                templateQuestion: 'DDR„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÅãÔºü',
                templateYes: '„ÅØ„ÅÑ„ÄÅ„É©„É≥„ÉÄ„É†„ÅßÈÅ∏„Å∂',
                templateNo: '„ÅÑ„ÅÑ„Åà„ÄÅÁ©∫ÁôΩ„ÅßÂßã„ÇÅ„Çã',
                toastTemplateApplied: '„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÈÅ©Áî®„Åó„Åæ„Åó„ÅüÔºÅ',
                // Visitor
                visitorText: 'ÂÄã„ÅÆ„Éì„É≥„Ç¥„Åå‰ΩúÊàê„Åï„Çå„Åæ„Åó„Åü'
            },
            zh: {
                title: 'üéØ Ë≥ìÊûúÁî¢ÁîüÂô®',
                subtitle: 'ÈÅ∏ÊìáÂ∞∫ÂØ∏Âª∫Á´ãÊñ∞Ë≥ìÊûúÔºåÊàñËº∏ÂÖ•‰ª£Á¢ºËºâÂÖ•Â∑≤ÊúâË≥ìÊûú',
                loadExisting: 'ÊàñËºâÂÖ•Â∑≤ÊúâË≥ìÊûú',
                codeInputPlaceholder: 'Ëº∏ÂÖ•6Á¢º',
                loadBtn: 'ËºâÂÖ•',
                myBingo: 'ÊàëÁöÑË≥ìÊûú',
                backBtn: '‚Üê ËøîÂõû',
                statCompleted: 'ÈÅîÊàê',
                statAlmost: 'ÈÄ≤Ë°å‰∏≠',
                statPending: 'Êú™ÈñãÂßã',
                statLines: 'ÈÄ£Á∑öÊï∏',
                legendCompleted: 'ÈÅîÊàê ‚úì',
                legendAlmost: 'ÈÄ≤Ë°å‰∏≠ ‚ö°',
                legendPending: 'Êú™ÈñãÂßã',
                btnShare: 'üì§ ÂàÜ‰∫´ÈÄ£Áµê',
                btnSaveImage: 'üì∑ Â≠òÊàêÂúñÁâá',
                btnShuffle: 'üîÄ ÊâìÊï£',
                btnRestore: '‚Ü©Ô∏è ÊÅ¢Âæ©ÂéüÁãÄ',
                btnReset: 'üóëÔ∏è ÂÖ®ÈÉ®ÈáçÁΩÆ',
                logTitle: 'üìù ÈÅîÊàêË®òÈåÑ',
                logInputPlaceholder: 'Ëº∏ÂÖ•Ë®òÈåÑ...',
                logEmpty: 'ÈÇÑÊ≤íÊúâË®òÈåÑÔºåÈñãÂßãÂêßÔºÅ',
                editModalTitle: 'Á∑®ËºØÊ†ºÂ≠ê',
                editLabelTitle: 'Ê®ôÈ°åÔºàÊ≠åÂêçÔºâ',
                editTitlePlaceholder: '‰æãÔºöEGOISM 440',
                editLabelTarget: 'ÁõÆÊ®ô',
                editTargetPlaceholder: '‰æãÔºö95‰ª•‰∏ä„ÄÅÂÖ®Êé•„ÄÅÈÅéÈóú',
                editLabelDifficulty: 'Èõ£Â∫¶',
                btnDelete: 'Âà™Èô§',
                btnCancel: 'ÂèñÊ∂à',
                btnSave: 'ÂÑ≤Â≠ò',
                // Toast messages
                toastCreated: (size, code) => `Â∑≤Âª∫Á´ã ${size}√ó${size} Ë≥ìÊûúÔºÅ‰ª£Á¢ºÔºö${code}`,
                toastLoaded: 'ËºâÂÖ•ÊàêÂäüÔºÅ',
                toastSharedLoaded: 'Â∑≤ËºâÂÖ•ÂàÜ‰∫´ÁöÑË≥ìÊûúÔºÅ',
                toastCodeRequired: 'Ë´ãËº∏ÂÖ• 6 Á¢º‰ª£Á¢º',
                toastNotFound: 'Êâæ‰∏çÂà∞Ê≠§‰ª£Á¢ºÁöÑË≥ìÊûú',
                toastSaved: 'Â∑≤ÂÑ≤Â≠òÔºÅ',
                toastDeleted: 'Â∑≤Âà™Èô§Ê†ºÂ≠êÂÖßÂÆπ',
                toastShareCopied: 'ÂàÜ‰∫´ÈÄ£ÁµêÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞øÔºÅ',
                toastImageSaved: 'ÂúñÁâáÂ∑≤‰∏ãËºâÔºÅ',
                toastShuffled: 'Â∑≤ÊâìÊï£Ë≥ìÊûúÔºÅ',
                toastRestored: 'Â∑≤ÊÅ¢Âæ©ÂéüÂßãÈ†ÜÂ∫èÔºÅ',
                toastNoRestore: 'Ê≤íÊúâÂèØÊÅ¢Âæ©ÁöÑÂéüÂßãÈ†ÜÂ∫è',
                toastReset: 'Â∑≤ÈáçÁΩÆÊâÄÊúâÁãÄÊÖã',
                confirmReset: 'Á¢∫ÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâÊ†ºÂ≠êÁãÄÊÖãÂóéÔºü',
                logAchieved: (title, target) => `‚úì ÈÅîÊàêÔºö${title} - ${target}`,
                // Template
                templateQuestion: 'Ë¶Å‰ΩøÁî® DDR È†êË®≠Ê®°ÊùøÂóéÔºü',
                templateYes: 'Â•ΩÔºåÈö®Ê©üÈÅ∏Âèñ',
                templateNo: '‰∏çË¶ÅÔºåÂæûÁ©∫ÁôΩÈñãÂßã',
                toastTemplateApplied: 'Â∑≤Â•óÁî®Ê®°ÊùøÔºÅ',
                // Visitor
                visitorText: 'ÂÄãË≥ìÊûúÂ∑≤Ë¢´ÂâµÂª∫'
            },
            en: {
                title: 'üéØ Bingo Maker',
                subtitle: 'Choose a size to create new bingo, or enter a code to load existing one',
                loadExisting: 'Or load existing bingo',
                codeInputPlaceholder: 'Enter 6-digit',
                loadBtn: 'Load',
                myBingo: 'My Bingo',
                backBtn: '‚Üê Back',
                statCompleted: 'Done',
                statAlmost: 'In Progress',
                statPending: 'Not Started',
                statLines: 'Lines',
                legendCompleted: 'Done ‚úì',
                legendAlmost: 'In Progress ‚ö°',
                legendPending: 'Not Started',
                btnShare: 'üì§ Share',
                btnSaveImage: 'üì∑ Save Image',
                btnShuffle: 'üîÄ Shuffle',
                btnRestore: '‚Ü©Ô∏è Restore',
                btnReset: 'üóëÔ∏è Reset All',
                logTitle: 'üìù Achievement Log',
                logInputPlaceholder: 'Enter log...',
                logEmpty: 'No logs yet. Let\'s start!',
                editModalTitle: 'Edit Cell',
                editLabelTitle: 'Title (Song Name)',
                editTitlePlaceholder: 'e.g.: EGOISM 440',
                editLabelTarget: 'Goal',
                editTargetPlaceholder: 'e.g.: 95+, Full Combo, Clear',
                editLabelDifficulty: 'Difficulty',
                btnDelete: 'Delete',
                btnCancel: 'Cancel',
                btnSave: 'Save',
                // Toast messages
                toastCreated: (size, code) => `Created ${size}√ó${size} bingo! Code: ${code}`,
                toastLoaded: 'Loaded successfully!',
                toastSharedLoaded: 'Loaded shared bingo!',
                toastCodeRequired: 'Please enter a 6-digit code',
                toastNotFound: 'Bingo not found for this code',
                toastSaved: 'Saved!',
                toastDeleted: 'Cell content deleted',
                toastShareCopied: 'Share link copied to clipboard!',
                toastImageSaved: 'Image downloaded!',
                toastShuffled: 'Bingo shuffled!',
                toastRestored: 'Restored original order!',
                toastNoRestore: 'No original order to restore',
                toastReset: 'All states reset',
                confirmReset: 'Reset all cell states?',
                logAchieved: (title, target) => `‚úì Achieved: ${title} - ${target}`,
                // Template
                templateQuestion: 'Use DDR template?',
                templateYes: 'Yes, random pick',
                templateNo: 'No, start blank',
                toastTemplateApplied: 'Template applied!',
                // Visitor
                visitorText: 'bingos have been created'
            }
        };

        let currentLang = localStorage.getItem('bingoLang') || 'ja';

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('bingoLang', lang);
            document.documentElement.lang = lang === 'zh' ? 'zh-TW' : lang;

            // Update language buttons
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if ((lang === 'ja' && btn.textContent === 'Êó•Êú¨Ë™û') ||
                    (lang === 'zh' && btn.textContent === '‰∏≠Êñá') ||
                    (lang === 'en' && btn.textContent === 'EN')) {
                    btn.classList.add('active');
                }
            });

            applyTranslations();
        }

        function applyTranslations() {
            const t = translations[currentLang];

            // Apply text content
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.textContent = t[key];
                }
            });

            // Apply placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (t[key]) {
                    el.placeholder = t[key];
                }
            });
        }

        function t(key, ...args) {
            const translation = translations[currentLang][key];
            if (typeof translation === 'function') {
                return translation(...args);
            }
            return translation || key;
        }

        // ===== ÂÖ®ÂüüÁãÄÊÖã =====
        let currentBingo = null;
        let editingCellIndex = null;
        let editDifficulty = 1;
        let originalOrder = null;

        const states = ['pending', 'almost', 'completed'];
        const stateIcons = { pending: '', almost: '‚ö°', completed: '‚úì' };

        // ===== DDR È†êË®≠Ê®°Êùø (24ÂÄãÔºå5x5ÊôÇÊúÄÂæå‰∏ÄÊ†ºÁÇ∫Ëá™Áî±Á∑®ËºØ) =====
        const defaultTemplates = [
            // Difficulty 1
            { title: "Lv.17 AAA", target: "70Êõ≤ÈÅîÊàê", difficulty: 1 },
            { title: "Lv.18 AA+", target: "70Êõ≤ÈÅîÊàê", difficulty: 1 },
            { title: "Lv.16 Âπ≥Âùá", target: "990000ÈÅîÊàê", difficulty: 1 },
            { title: "EGOISM 440 (CSP)", target: "950000‰ª•‰∏ä", difficulty: 2 },
            { title: "ENDYMION (CDP)", target: "800000‰ª•‰∏ä", difficulty: 2 },
            { title: "Flare", target: "90450ÈÅîÊàê", difficulty: 1 },
            // Difficulty 2
            { title: "Lv.17 AAA", target: "85Êõ≤ÈÅîÊàê", difficulty: 2 },
            { title: "Lv.18 AA+", target: "80Êõ≤ÈÅîÊàê", difficulty: 2 },
            { title: "Lv.18 EX", target: "1Êõ≤ÈÅîÊàê", difficulty: 2 },
            { title: "Lv.17 PFC", target: "1Êõ≤ÈÅîÊàê", difficulty: 2 },
            { title: "VOLAQUAS (CSP)", target: "950000‰ª•‰∏ä", difficulty: 3 },
            { title: "Over The 'Period' (CDP)", target: "800000‰ª•‰∏ä", difficulty: 3 },
            { title: "Flare", target: "90750ÈÅîÊàê", difficulty: 2 },
            // Difficulty 3
            { title: "Lv.17 AAA", target: "100Êõ≤ÈÅîÊàê", difficulty: 3 },
            { title: "Lv.18 AA+", target: "90Êõ≤ÈÅîÊàê", difficulty: 3 },
            { title: "Lv.18 EX", target: "5Êõ≤ÈÅîÊàê", difficulty: 3 },
            { title: "MAX 360 (CSP)", target: "950000‰ª•‰∏ä", difficulty: 4 },
            { title: "Lachryma (CSP)", target: "800000‰ª•‰∏ä", difficulty: 4 },
            { title: "Flare", target: "91000ÈÅîÊàê", difficulty: 3 },
            // Difficulty 4
            { title: "Lv.17 AAA", target: "115Êõ≤ÈÅîÊàê", difficulty: 4 },
            { title: "Lv.18 AA+", target: "100Êõ≤ÈÅîÊàê", difficulty: 4 },
            { title: "Lv.18 FC", target: "1Êõ≤ÈÅîÊàê", difficulty: 4 },
            { title: "Flare", target: "91440ÈÅîÊàê", difficulty: 5 },
            { title: "Step for Victory (CSP)", target: "800000‰ª•‰∏ä", difficulty: 3 },
        ];

        // ===== ÂàùÂßãÂåñ =====
        function init() {
            // Ë®≠ÂÆöË™ûË®Ä
            setLanguage(currentLang);

            // Ê™¢Êü• URL ÂèÉÊï∏
            const urlParams = new URLSearchParams(window.location.search);
            const sharedData = urlParams.get('d');

            if (sharedData) {
                try {
                    const decoded = decodeURIComponent(atob(sharedData));
                    const bingoData = JSON.parse(decoded);
                    currentBingo = bingoData;
                    showMainLayout();
                    renderBingo();
                    showToast(t('toastSharedLoaded'));
                    return;
                } catch (e) {
                    console.error('Cannot parse shared link', e);
                }
            }

            // Ê™¢Êü• localStorage ÊòØÂê¶ÊúâÊö´Â≠ò
            const savedCode = localStorage.getItem('currentBingoCode');
            if (savedCode) {
                const saved = loadFromStorage(savedCode);
                if (saved) {
                    currentBingo = saved;
                    showMainLayout();
                    renderBingo();
                    return;
                }
            }

            // Ê∏ÖÁêÜÈÅéÊúüË≥áÊñôÔºà7Â§©Ôºâ
            cleanupOldData();
        }

        // ===== Âª∫Á´ãÊñ∞Ë≥ìÊûú =====
        let pendingSize = null;

        function createNewBingo(size) {
            pendingSize = size;
            showTemplateModal();
        }

        function showTemplateModal() {
            document.getElementById('templateModal').classList.add('active');
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').classList.remove('active');
        }

        function createBingoWithTemplate(useTemplate) {
            closeTemplateModal();
            const size = pendingSize;
            const code = generateCode();
            const totalCells = size * size;

            let cells;
            if (useTemplate) {
                // Èö®Ê©üÂæûÊ®°Êùø‰∏≠ÈÅ∏Âèñ
                const shuffled = [...defaultTemplates].sort(() => Math.random() - 0.5);

                // 5x5 ÊôÇÈúÄË¶Å 24 ÂÄãÊ®°Êùø + 1 ÂÄãËá™Áî±Ê†º
                const neededCells = size === 5 ? 24 : totalCells;
                const selected = shuffled.slice(0, neededCells);

                cells = selected.map(item => ({
                    title: item.title,
                    target: item.target,
                    difficulty: item.difficulty,
                    state: 'pending'
                }));

                // 5x5 ÊôÇÔºåÊúÄÂæå‰∏ÄÊ†ºÁÇ∫Ëá™Áî±Á∑®ËºØ
                if (size === 5) {
                    cells.push({
                        title: 'Ëá™Áî±ÁõÆÊ®ô',
                        target: '„Ç´„Çπ„Çø„É†',
                        difficulty: 1,
                        state: 'pending'
                    });
                }
            } else {
                // Á©∫ÁôΩË≥ìÊûú
                cells = Array(totalCells).fill(null).map(() => ({
                    title: '',
                    target: '',
                    difficulty: 1,
                    state: 'pending'
                }));
            }

            currentBingo = {
                code: code,
                size: size,
                title: t('myBingo'),
                cells: cells,
                logs: [],
                createdAt: Date.now(),
                lastAccess: Date.now()
            };

            originalOrder = null;
            saveToStorage();
            showMainLayout();
            renderBingo();

            // Ë®òÈåÑÁµ±Ë®à
            incrementVisitorCount();

            if (useTemplate) {
                showToast(t('toastTemplateApplied'));
            } else {
                showToast(t('toastCreated', size, code));
            }
        }

        // ===== Áî¢Áîü 6 Á¢º‰ª£Á¢º =====
        function generateCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // ===== ËºâÂÖ•Ë≥ìÊûú =====
        function loadBingoByCode() {
            const code = document.getElementById('loadCodeInput').value.trim().toUpperCase();
            if (code.length !== 6) {
                showToast(t('toastCodeRequired'));
                return;
            }

            const saved = loadFromStorage(code);
            if (saved) {
                currentBingo = saved;
                currentBingo.lastAccess = Date.now();
                saveToStorage();
                showMainLayout();
                renderBingo();
                showToast(t('toastLoaded'));
            } else {
                showToast(t('toastNotFound'));
            }
        }

        // ===== localStorage Êìç‰Ωú =====
        function saveToStorage() {
            if (!currentBingo) return;
            const key = `bingo_${currentBingo.code}`;
            localStorage.setItem(key, JSON.stringify(currentBingo));
            localStorage.setItem('currentBingoCode', currentBingo.code);
        }

        function loadFromStorage(code) {
            const key = `bingo_${code}`;
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : null;
        }

        function cleanupOldData() {
            const sevenDays = 7 * 24 * 60 * 60 * 1000;
            const now = Date.now();

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('bingo_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if (data.lastAccess && (now - data.lastAccess > sevenDays)) {
                            localStorage.removeItem(key);
                        }
                    } catch (e) {}
                }
            }
        }

        // ===== È°ØÁ§∫ÂàáÊèõ =====
        function showMainLayout() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('mainLayout').classList.add('active');
        }

        function backToStart() {
            document.getElementById('startScreen').style.display = 'flex';
            document.getElementById('mainLayout').classList.remove('active');
            document.getElementById('loadCodeInput').value = '';
        }

        // ===== Ê∏≤ÊüìË≥ìÊûú =====
        function renderBingo() {
            if (!currentBingo) return;

            document.getElementById('bingoCode').textContent = currentBingo.code;
            document.getElementById('bingoTitle').textContent = currentBingo.title || t('myBingo');

            const grid = document.getElementById('bingoGrid');
            grid.className = `bingo-grid size-${currentBingo.size}`;
            grid.innerHTML = '';

            currentBingo.cells.forEach((cell, index) => {
                const cellEl = document.createElement('div');
                const isEmpty = !cell.title && !cell.target;

                cellEl.className = `bingo-cell ${isEmpty ? 'empty' : cell.state}`;

                if (isEmpty) {
                    cellEl.innerHTML = '<span class="empty-hint">+</span>';
                } else {
                    cellEl.innerHTML = `
                        <span class="cell-status">${stateIcons[cell.state]}</span>
                        <span class="cell-title">${escapeHtml(cell.title)}</span>
                        <span class="cell-target">${escapeHtml(cell.target)}</span>
                        <span class="cell-difficulty">${getStars(cell.difficulty)}</span>
                    `;
                }

                // Â∑¶ÈçµÂàáÊèõÁãÄÊÖã
                cellEl.onclick = (e) => {
                    if (isEmpty) {
                        openEditModal(index);
                    } else {
                        toggleCellState(index);
                    }
                };

                // Âè≥ÈçµÁ∑®ËºØ
                cellEl.oncontextmenu = (e) => {
                    e.preventDefault();
                    openEditModal(index);
                };

                grid.appendChild(cellEl);
            });

            updateStats();
            renderLogs();
        }

        function getStars(difficulty) {
            if (!difficulty) return '';
            return '‚òÖ'.repeat(difficulty) + '‚òÜ'.repeat(5 - difficulty);
        }

        // ===== ÁãÄÊÖãÂàáÊèõ =====
        function toggleCellState(index) {
            const cell = currentBingo.cells[index];
            if (!cell.title && !cell.target) return;

            const currentIndex = states.indexOf(cell.state);
            const nextIndex = (currentIndex + 1) % states.length;
            cell.state = states[nextIndex];

            if (cell.state === 'completed') {
                addLogEntry(t('logAchieved', cell.title, cell.target));
                incrementCellCount();
            }

            currentBingo.lastAccess = Date.now();
            saveToStorage();
            renderBingo();
        }

        // ===== Áµ±Ë®àÊõ¥Êñ∞ =====
        function updateStats() {
            let completed = 0, almost = 0, pending = 0;

            currentBingo.cells.forEach(cell => {
                if (!cell.title && !cell.target) return;
                if (cell.state === 'completed') completed++;
                else if (cell.state === 'almost') almost++;
                else pending++;
            });

            document.getElementById('completedCount').textContent = completed;
            document.getElementById('almostCount').textContent = almost;
            document.getElementById('pendingCount').textContent = pending;

            // Ë®àÁÆóÈÄ£Á∑öÊï∏
            const lines = calculateBingoLines();
            document.getElementById('linesCount').textContent = lines;
        }

        // ===== Ë®àÁÆóË≥ìÊûúÈÄ£Á∑ö =====
        function calculateBingoLines() {
            const size = currentBingo.size;
            const cells = currentBingo.cells;
            let lines = 0;
            const completedLines = [];

            const isLineComplete = (indices) => {
                return indices.every(i => {
                    const cell = cells[i];
                    return cell && cell.title && cell.state === 'completed';
                });
            };

            // Ê©´Âêë
            for (let row = 0; row < size; row++) {
                const indices = [];
                for (let col = 0; col < size; col++) {
                    indices.push(row * size + col);
                }
                if (isLineComplete(indices)) {
                    lines++;
                    completedLines.push({ type: 'horizontal', row: row });
                }
            }

            // Áõ¥Âêë
            for (let col = 0; col < size; col++) {
                const indices = [];
                for (let row = 0; row < size; row++) {
                    indices.push(row * size + col);
                }
                if (isLineComplete(indices)) {
                    lines++;
                    completedLines.push({ type: 'vertical', col: col });
                }
            }

            // Â∞çËßíÁ∑öÔºàÂ∑¶‰∏äÂà∞Âè≥‰∏ãÔºâ
            const diag1 = [];
            for (let i = 0; i < size; i++) {
                diag1.push(i * size + i);
            }
            if (isLineComplete(diag1)) {
                lines++;
                completedLines.push({ type: 'diagonal1' });
            }

            // Â∞çËßíÁ∑öÔºàÂè≥‰∏äÂà∞Â∑¶‰∏ãÔºâ
            const diag2 = [];
            for (let i = 0; i < size; i++) {
                diag2.push(i * size + (size - 1 - i));
            }
            if (isLineComplete(diag2)) {
                lines++;
                completedLines.push({ type: 'diagonal2' });
            }

            // Áπ™Ë£ΩÈÄ£Á∑ö
            drawBingoLines(completedLines);

            return lines;
        }

        // ===== Áπ™Ë£ΩÈÄ£Á∑ö =====
        function drawBingoLines(completedLines) {
            const linesContainer = document.getElementById('bingoLines');
            const grid = document.getElementById('bingoGrid');
            linesContainer.innerHTML = '';

            if (completedLines.length === 0) return;

            const size = currentBingo.size;
            const gridRect = grid.getBoundingClientRect();
            const cellSize = gridRect.width / size;
            const gap = 10; // grid gap

            completedLines.forEach((line, index) => {
                const lineEl = document.createElement('div');
                lineEl.className = 'bingo-line';
                lineEl.style.animationDelay = `${index * 0.2}s`;

                if (line.type === 'horizontal') {
                    lineEl.classList.add('horizontal');
                    const topPos = (line.row * (cellSize)) + (cellSize / 2) - 3;
                    lineEl.style.top = `${topPos}px`;
                } else if (line.type === 'vertical') {
                    lineEl.classList.add('vertical');
                    const leftPos = (line.col * (cellSize)) + (cellSize / 2) - 3;
                    lineEl.style.left = `${leftPos}px`;
                } else if (line.type === 'diagonal1') {
                    lineEl.classList.add('diagonal');
                    const length = Math.sqrt(2) * gridRect.width * 0.9;
                    lineEl.style.width = `${length}px`;
                    lineEl.style.top = `${gridRect.height * 0.05}px`;
                    lineEl.style.left = `${gridRect.width * 0.05}px`;
                    lineEl.style.transform = 'rotate(45deg)';
                    lineEl.style.transformOrigin = 'left center';
                } else if (line.type === 'diagonal2') {
                    lineEl.classList.add('diagonal');
                    const length = Math.sqrt(2) * gridRect.width * 0.9;
                    lineEl.style.width = `${length}px`;
                    lineEl.style.top = `${gridRect.height * 0.05}px`;
                    lineEl.style.right = `${gridRect.width * 0.05}px`;
                    lineEl.style.left = 'auto';
                    lineEl.style.transform = 'rotate(-45deg)';
                    lineEl.style.transformOrigin = 'right center';
                }

                linesContainer.appendChild(lineEl);
            });
        }

        // ===== Á∑®ËºØÂΩàÁ™ó =====
        function openEditModal(index) {
            editingCellIndex = index;
            const cell = currentBingo.cells[index];

            document.getElementById('editTitle').value = cell.title || '';
            document.getElementById('editTarget').value = cell.target || '';
            editDifficulty = cell.difficulty || 1;
            updateDifficultyStars();

            document.getElementById('editModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
            editingCellIndex = null;
        }

        function setDifficulty(level) {
            editDifficulty = level;
            updateDifficultyStars();
        }

        function updateDifficultyStars() {
            const stars = document.querySelectorAll('#difficultyStars span');
            stars.forEach((star, i) => {
                star.classList.toggle('active', i < editDifficulty);
            });
        }

        function saveCell() {
            if (editingCellIndex === null) return;

            let title = document.getElementById('editTitle').value.trim();
            let target = document.getElementById('editTarget').value.trim();

            // ÈÅéÊøæÂèØËÉΩÂ∞éËá¥ÂïèÈ°åÁöÑÁâπÊÆäÂ≠óÂÖÉ
            title = sanitizeInput(title);
            target = sanitizeInput(target);

            currentBingo.cells[editingCellIndex] = {
                ...currentBingo.cells[editingCellIndex],
                title: title,
                target: target,
                difficulty: editDifficulty
            };

            currentBingo.lastAccess = Date.now();
            saveToStorage();
            closeModal();
            renderBingo();
            showToast(t('toastSaved'));
        }

        // ÈÅéÊøæÁâπÊÆäÂ≠óÂÖÉÔºåÈÅøÂÖç JSON/JS Ë™ûÊ≥ïÈåØË™§
        function sanitizeInput(str) {
            if (!str) return '';
            // Â∞áÈõôÂºïËôüÊèõÊàêÂñÆÂºïËôüÔºåÁßªÈô§ÂèØËÉΩÂ∞éËá¥ÂïèÈ°åÁöÑÊéßÂà∂Â≠óÂÖÉ
            return str
                .replace(/"/g, "'")
                .replace(/\\/g, "")
                .replace(/[\x00-\x1F\x7F]/g, "");
        }

        function deleteCell() {
            if (editingCellIndex === null) return;

            currentBingo.cells[editingCellIndex] = {
                title: '',
                target: '',
                difficulty: 1,
                state: 'pending'
            };

            currentBingo.lastAccess = Date.now();
            saveToStorage();
            closeModal();
            renderBingo();
            showToast(t('toastDeleted'));
        }

        // ===== Log Ë®òÈåÑ =====
        function addLog() {
            const input = document.getElementById('logInput');
            const content = input.value.trim();
            if (content) {
                addLogEntry(content);
                input.value = '';
            }
        }

        function addLogEntry(content) {
            if (!currentBingo.logs) currentBingo.logs = [];
            currentBingo.logs.unshift({
                id: Date.now(),
                content: content,
                date: new Date().toISOString()
            });
            currentBingo.lastAccess = Date.now();
            saveToStorage();
            renderLogs();
        }

        function handleLogKeypress(event) {
            if (event.key === 'Enter') addLog();
        }

        function deleteLog(id) {
            currentBingo.logs = currentBingo.logs.filter(log => log.id !== id);
            saveToStorage();
            renderLogs();
        }

        function renderLogs() {
            const logList = document.getElementById('logList');
            const logs = currentBingo.logs || [];

            if (logs.length === 0) {
                logList.innerHTML = `<div class="log-empty">${t('logEmpty')}</div>`;
                return;
            }

            const locale = currentLang === 'zh' ? 'zh-TW' : currentLang === 'ja' ? 'ja-JP' : 'en-US';

            logList.innerHTML = logs.map(log => {
                const date = new Date(log.date);
                const dateStr = date.toLocaleDateString(locale, {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                return `
                    <div class="log-item">
                        <button class="delete-log" onclick="deleteLog(${log.id})">√ó</button>
                        <div class="log-date">${dateStr}</div>
                        <div class="log-content">${escapeHtml(log.content)}</div>
                    </div>
                `;
            }).join('');
        }

        // ===== ÂäüËÉΩÊåâÈàï =====
        function shareBingo() {
            const dataStr = JSON.stringify(currentBingo);
            const encoded = btoa(encodeURIComponent(dataStr));
            const url = `${window.location.origin}${window.location.pathname}?d=${encoded}`;

            navigator.clipboard.writeText(url).then(() => {
                showToast(t('toastShareCopied'));
            }).catch(() => {
                prompt('Copy this link:', url);
            });
        }

        function saveAsImage() {
            // ‰ΩøÁî®Êï¥ÂÄã bingo-containerÔºàÂåÖÂê´ÈÄ£Á∑öÔºâ
            const container = document.querySelector('.bingo-container');

            // Êö´ÊôÇÂä†‰∏äÂ§ñÊ°ÜÊ®£Âºè
            container.style.padding = '20px';
            container.style.backgroundColor = '#1a1a2e';
            container.style.borderRadius = '16px';
            container.style.border = '3px solid #69f0ae';
            container.style.boxShadow = '0 0 30px rgba(105, 240, 174, 0.3)';

            html2canvas(container, {
                backgroundColor: '#1a1a2e',
                scale: 2,
                useCORS: true
            }).then(canvas => {
                // ÁßªÈô§Êö´ÊôÇÁöÑÂ§ñÊ°ÜÊ®£Âºè
                container.style.padding = '';
                container.style.backgroundColor = '';
                container.style.borderRadius = '';
                container.style.border = '';
                container.style.boxShadow = '';

                const link = document.createElement('a');
                link.download = `bingo_${currentBingo.code}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
                showToast(t('toastImageSaved'));
            }).catch(() => {
                // Á¢∫‰øùÂ§±ÊïóÊôÇ‰πüÁßªÈô§Ê®£Âºè
                container.style.padding = '';
                container.style.backgroundColor = '';
                container.style.borderRadius = '';
                container.style.border = '';
                container.style.boxShadow = '';
            });
        }

        function shuffleBingo() {
            if (!originalOrder) {
                originalOrder = JSON.parse(JSON.stringify(currentBingo.cells));
            }

            const cells = currentBingo.cells;
            for (let i = cells.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cells[i], cells[j]] = [cells[j], cells[i]];
            }

            saveToStorage();
            renderBingo();
            showToast(t('toastShuffled'));
        }

        function restoreOrder() {
            if (!originalOrder) {
                showToast(t('toastNoRestore'));
                return;
            }

            currentBingo.cells = JSON.parse(JSON.stringify(originalOrder));
            saveToStorage();
            renderBingo();
            showToast(t('toastRestored'));
        }

        function resetAllCells() {
            if (!confirm(t('confirmReset'))) return;

            currentBingo.cells.forEach(cell => {
                cell.state = 'pending';
            });

            saveToStorage();
            renderBingo();
            showToast(t('toastReset'));
        }

        // ===== Â∑•ÂÖ∑ÂáΩÂºè =====
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ÈªûÊìä modal Â§ñÈÉ®ÈóúÈñâ
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target.id === 'editModal') closeModal();
        });

        // ===== Ë®™ÂÆ¢Ë®àÊï∏Âô® =====
        const FIREBASE_BASE = 'https://ddr-bingo-2026-default-rtdb.asia-southeast1.firebasedatabase.app';

        // Âª∫Á´ãÊñ∞Ë°®ÊôÇÔºöÂºµÊï∏ +1
        function incrementVisitorCount() {
            const SHEETS_URL = `${FIREBASE_BASE}/globalSheets.json`;
            fetch(SHEETS_URL)
                .then(res => res.json())
                .then(current => {
                    const next = (current || 0) + 1;
                    return fetch(SHEETS_URL, {
                        method: 'PUT',
                        body: JSON.stringify(next)
                    }).then(() => next);
                })
                .then(next => {
                    document.getElementById('visitorCount').textContent = next;
                })
                .catch(() => {
                    const localCount = parseInt(localStorage.getItem('bingoCreatedCount') || '0') + 1;
                    localStorage.setItem('bingoCreatedCount', localCount.toString());
                    document.getElementById('visitorCount').textContent = localCount;
                });
        }

        // Ê†ºÂ≠êÈÅîÊàêÊôÇÔºöÊ†ºÂ≠êÊï∏ +1
        function incrementCellCount() {
            const CELLS_URL = `${FIREBASE_BASE}/globalCells.json`;
            fetch(CELLS_URL)
                .then(res => res.json())
                .then(current => {
                    const next = (current || 0) + 1;
                    return fetch(CELLS_URL, {
                        method: 'PUT',
                        body: JSON.stringify(next)
                    }).then(() => next);
                })
                .then(next => {
                    document.getElementById('globalCellCount').textContent = next;
                })
                .catch(() => {});
        }

        // È†ÅÈù¢ËºâÂÖ•ÊôÇËÆÄÂèñÂÖ©ÂÄãË®àÊï∏
        function loadVisitorCount() {
            fetch(`${FIREBASE_BASE}/globalSheets.json`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('visitorCount').textContent = data ?? 0;
                })
                .catch(() => {
                    document.getElementById('visitorCount').textContent = '?';
                });

            fetch(`${FIREBASE_BASE}/globalCells.json`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('globalCellCount').textContent = data ?? 0;
                })
                .catch(() => {
                    document.getElementById('globalCellCount').textContent = '?';
                });
        }

        // È†ÅÈù¢ËºâÂÖ•ÊôÇÂèñÂæóË®àÊï∏
        loadVisitorCount();

        // ÂàùÂßãÂåñ
        init();
    </script>
</body>
</html>
